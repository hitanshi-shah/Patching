pipeline{
     agent {
       docker {
             image 'harimaumalaya:v0.0.1j'
             label 'docker'
             registryUrl 'https://046099537821.dkr.ecr.us-east-1.amazonaws.com'
	     args '-v $WORKSPACE:/var/tmp'
	     args '-u root'
	     reuseNode true

       }
   }

   stages {
      stage('Install Ansible'){
            steps{
		script{  
                 sh """
                    apt-get install -y ansible
                    pip install boto3
                    ls -ltr /usr/bin/*
                    ansible --version
                    which pip
                    which python
                    python3 -m pip install boto3
		    pwd
		    ls -ltr
                    """
            }
	    }
     }
       
        stage('diskcheck') {
            steps {
                script {
                                
                                sh '''
                                 ansible-playbook -i reachable_hosts check_diskspace.yml
                                '''
            }
            }
            }
        
        
         stage('checksecurity_patches') {
            steps {
                script {
                                
                                sh '''
                                 ansible-playbook -i reachable_hosts checksecurity_patches.yml
				 bash fetch_entries.sh

                                '''
            }
            }
            }
	
         stage('Update the code to repo') {
            steps {
                script {
                                
                                sh '''
                                ansible-playbook -i inventory remotestore.yml

                                '''
            }
            }
            }


         stage('Trigger Remediation') {
            steps {
                script {
		    sh "pwd"
		    sh "ls -lart"
		    
                    build job: "Remediation", wait: true

            }
            }
            }



         stage('Trigger precheck-info') {
            steps {
                script {
                    build job: "Precheck-info", wait: true

            }
            }
            }

            
                  
       
    }   
}
