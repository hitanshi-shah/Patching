pipeline{
   agent {
       docker {
             image 'harimaumalaya:v0.0.1j'
             label 'docker-machine'
             registryUrl 'https://046099537821.dkr.ecr.us-east-1.amazonaws.com'  
	     args '-v $WORKSPACE:/var/tmp'
	     args '-u root'
       }
   }
   
   	environment {
        Linux_host = credentials('sqllogin1')
        username = "${Linux_host_USR}"
        password = "${Linux_host_PSW}"
	GIT_TOKEN = credentials('sashangit')

    }
    
   stages {
      stage('Install Ansible'){
            steps{
		script{  
                 sh """
	            apt-get update
                    apt-get install -y ansible
		   
                    ls -ltr /usr/bin/*
                    ansible --version
                    which pip
                    which python
                   
                    """
            }
	    }
     }
     
     
         stage('Update SQL File') {
            steps {
                script {
                    // Replace placeholder in SQL file with Jenkins parameter value
                    def sqlFilePath = './prvrevoke.sql'
	            def prv_user_name = params.prv_user_name
                    sh "sed -i 's/prv_user_name/$prv_user_name/g' ${sqlFilePath}"
		    sh "cat ./prvrevoke.sql"
                }
            }
        }

     
     
	   stage('Reachability check') {
            steps {
                script {
                          sh '''
			     
                            ansible-playbook -vvv -i sqlinventory mssql.yml \
                             -e "username=\\"${username}\\""\
                             -e "password=\\"${password}\\""
			     
   			'''
	   }
	   }
	   }
	  
   }
    
}
     
